<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login</title>
  <link rel="stylesheet" href="./login.css">
  <!-- Añadir SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
  <div class="login-container">
    <div class="login-card">
      <h2>Welcome Back</h2>
      <p>Please login to your account</p>
      <form id="loginForm">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="you@example.com" required />

        <label for="password">Password</label>
        <input type="password" id="password" placeholder="••••••••" required />

        <button type="submit">Login</button>
      </form>
      <div class="footer-text">
        <p>Don't have an account? <a href="./registro/registro.html">Register</a></p>
      </div>
    </div>
  </div>

  <!-- Añadir SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("loginForm");
  const email = document.getElementById("email");
  const password = document.getElementById("password");

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      try {
        // Mostrar loader
        Swal.fire({
          title: "Iniciando sesión...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // Validación básica en el cliente
        if (!email.value.trim() || !password.value) {
          throw new Error("Por favor completa todos los campos");
        }

        console.log('🔄 Enviando login...');

        // Enviar credenciales al servidor
        const response = await fetch("/api/user/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            email: email.value.trim(),
            password: password.value
          })
        });

        console.log('📡 Status:', response.status);
        const data = await response.json();
        console.log('📄 Data:', data);

        if (!response.ok) {
          const errorMsg = data.msg || "Credenciales incorrectas";
          throw new Error(errorMsg);
        }

        // ✅ GUARDAR TOKEN EN LOCALSTORAGE
        if (data.token) {
          const cleanToken = data.token.toString().trim();
          localStorage.setItem('token', cleanToken);
          console.log('💾 Token guardado:', localStorage.getItem('token'));
        } else {
          console.error('❌ No token en respuesta');
          throw new Error('No se recibió token');
        }

        Swal.fire({
          icon: "success",
          title: "¡Bienvenido!",
          text: data.message || "Inicio de sesión exitoso",
          timer: 2000,
          showConfirmButton: false,
          willClose: () => {
            console.log('🎯 Redirigiendo a dashboard...');
            window.location.href = "/dashboard";
          }
        });

      } catch (error) {
        Swal.close();
        console.error('❌ Error login:', error);

        let errorMessage = "Error al iniciar sesión";

        if (error.message.includes("Failed to fetch")) {
          errorMessage = "No se pudo conectar al servidor. Verifica tu conexión.";
        } else if (error.message) {
          errorMessage = error.message;
        }

        Swal.fire({
          icon: "error",
          title: "Error",
          text: errorMessage,
          confirmButtonText: "Entendido"
        });

        password.value = "";
      }
    });
  }

  // Logout button (si existe en esta página)
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async function () {
      try {
        // Limpiar localStorage
        localStorage.removeItem('token');
        
        // Llamar al logout del servidor
        await fetch('/api/user/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
          }
        });

        Swal.fire({
          icon: 'success',
          title: "Sesión cerrada correctamente",
          showConfirmButton: false,
          timer: 1500
        });

        setTimeout(() => {
          window.location.href = '/';
        }, 1600);

      } catch (error) {
        // Aunque falle el logout del servidor, limpiamos localStorage
        localStorage.removeItem('token');
        window.location.href = '/';
      }
    });
  }
});
</script>

</body>

</html>
